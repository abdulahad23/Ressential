@model Ressential.Models.ReceiptVoucher

@{ ViewBag.Title = "CreateReceiptVoucher";
    Layout = "~/Views/Shared/_WarehouseLayout.cshtml"; }
@using (Html.BeginForm("CreateReceiptVoucher", "Warehouse", FormMethod.Post, new { enctype = "multipart/form-data" }))
{

    <div class="row">
        <div class="col-12 grid-margin">
            <div class="card">
                <div class="card-body">
                    <h2 class="text-secondary"><b>Create Receipt Voucher</b></h2>
                    <div class="row">

                        <div class="col-md-6">
                            <div class="form-floating mb-3 mt-3">
                                @Html.TextBoxFor(model => model.ReceiptVoucherDate, DateTime.Today.ToString("yyyy-MM-dd"), new { @class = "form-control", @placeholder = "Receipt Voucher Date", @type = "date" })
                                <label for="floatingVoucherDate">Voucher Date</label>
                                @Html.ValidationMessageFor(model => model.ReceiptVoucherDate, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3 mt-3">

                                @Html.DropDownListFor(model => model.VendorId, new SelectList(ViewBag.Vendors, "VendorId", "Name"), "Select Vendor", new { @class = "form-control" })
                                <label for="floatingInput">Vendor ID</label>
                                @Html.ValidationMessageFor(model => model.VendorId, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3 mt-3">
                                <select class="form-control" id="floatingPaymentMethod">
                                    <option value="Bank">Bank</option>
                                    <option value="Cash">Cash</option>
                                </select>
                                <label for="floatingPaymentMethod">Payment Method</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3 mt-3">
                                @Html.DropDownListFor(model => model.AccountId, new SelectList(ViewBag.Accounts, "AccountId", "AccountTitle"), "Select Account", new { @class = "form-control", id = "floatingAccountId" })
                                <label for="floatingInput">Account</label>
                                @Html.ValidationMessageFor(model => model.AccountId, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3 mt-3">
                                @Html.TextBoxFor(model => model.InstrumentNo, new { @class = "form-control", id = "floatingInstrumentNo", @placeholder = "Instrument No" })
                                <label for="floatingInstrumentNo">Instrument No</label>
                                @Html.ValidationMessageFor(model => model.InstrumentNo, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating mb-3 mt-3">
                                @Html.TextBoxFor(model => model.InstrumentDate, DateTime.Today.ToString("yyyy-MM-dd"), new { @class = "form-control", id = "floatingInstrumentDate", @placeholder = "Instrument Date", @type = "date" })
                                <label for="floatingInstrumentDate">Instrument Date</label>
                                @Html.ValidationMessageFor(model => model.InstrumentDate, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating mb-3 mt-3">
                                @Html.TextBoxFor(model => model.Amount, new { @class = "form-control", @type = "number", @placeholder = "Amount" })
                                <label for="floatingAmount">Amount</label>
                                @Html.ValidationMessageFor(model => model.Amount, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <h2 class="text-secondary"><b>Attachment</b></h2>
                        <div class="col-md-6">
                            <div class="form-floating mb-3 mt-3">
                                <div id="drop-zone" class="drop-zone" style="border: 2px dashed #ddd; padding: 20px; text-align: center; cursor: pointer;">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                    <input type="file" class="form-control" id="floatingPaymentAttachment" name="files" accept=".jpg,.jpeg,.png,.pdf" multiple style="display: none;">
                                    <br />

                                    <label for="floatingPaymentAttachment" class="text-primary" style="cursor: pointer;">Browse files</label>
                                    <p class="text-muted">Drag & drop files here or click to select files</p>
                                </div>
                                <div id="preview" class="preview-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;"></div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-secondary mr-2 ps-4 pe-4">Save</button>
                                    <a href="@Url.Action("ReceiptVoucherList","Warehouse")" class="btn btn-light ms-1 ps-4 pe-4">Cancel</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filePreviewModalLabel">File Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="filePreviewContent" style="text-align: center;"></div>
                </div>
                <div class="modal-footer">
                    <a id="downloadButton" class="btn btn-primary" href="#" download>Download</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
                    
 }
<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('floatingPaymentAttachment');
    const preview = document.getElementById('preview');
    let selectedFiles = [];

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '#e9ecef';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.backgroundColor = '';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '';
        handleFiles(e.dataTransfer.files);
    });

    dropZone.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', () => {
        handleFiles(fileInput.files);
    });

    const handleFiles = (files) => {
        selectedFiles = [...files];
        displayPreviews(selectedFiles);
    };

    const displayPreviews = (files) => {
        preview.innerHTML = '';
        files.forEach((file, index) => {
            const fileReader = new FileReader();
            fileReader.onload = (e) => {
                const fileType = file.type;
                const fileContainer = document.createElement('div');
                fileContainer.style.position = 'relative';
                fileContainer.style.display = 'inline-block';

                const removeButton = document.createElement('span');
                removeButton.innerHTML = '&times;';
                removeButton.style.position = 'absolute';
                removeButton.style.top = '0';
                removeButton.style.right = '0';
                removeButton.style.cursor = 'pointer';
                removeButton.style.color = 'red';
                removeButton.style.fontWeight = 'bold';
                removeButton.onclick = () => removeFile(index);

                fileContainer.appendChild(removeButton);

                if (fileType.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.border = '1px solid #ddd';
                    img.style.borderRadius = '8px';
                    img.onclick = () => showModal(e.target.result, file.name);
                    fileContainer.appendChild(img);
                } else {
                    const fileDiv = document.createElement('div');
                    fileDiv.textContent = file.name;
                    fileDiv.style.border = '1px solid #ddd';
                    fileDiv.style.padding = '10px';
                    fileDiv.style.width = '100px';
                    fileDiv.style.textAlign = 'center';
                    fileDiv.style.borderRadius = '8px';
                    fileDiv.onclick = () => showModal(e.target.result, file.name);
                    fileContainer.appendChild(fileDiv);
                }

                preview.appendChild(fileContainer);
            };
            fileReader.readAsDataURL(file);
        });
    };

    const removeFile = (index) => {
        selectedFiles.splice(index, 1);
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
        displayPreviews(selectedFiles);
    };

    const showModal = (fileSrc, fileName) => {
        const filePreviewContent = document.getElementById('filePreviewContent');
        const downloadButton = document.getElementById('downloadButton');

        filePreviewContent.innerHTML = ''; // Clear previous content

        if (fileSrc.startsWith('data:image/')) {
            const img = document.createElement('img');
            img.src = fileSrc;
            img.style.width = '100%';
            img.style.borderRadius = '8px';
            filePreviewContent.appendChild(img);
        } else {
            const iframe = document.createElement('iframe');
            iframe.src = fileSrc;
            iframe.style.width = '100%';
            iframe.style.height = '500px';
            iframe.style.border = 'none';
            filePreviewContent.appendChild(iframe);
        }

        downloadButton.href = fileSrc;
        downloadButton.download = fileName;

        const filePreviewModal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
        filePreviewModal.show();
    };

$(document).ready(function () {
    function loadAccounts(paymentMethod) {
        $.ajax({
            url: '@Url.Action("GetAccountsByPaymentMethod", "Warehouse")',
            type: 'GET',
            data: { paymentMethod: paymentMethod },
            success: function (data) {
                $('#floatingAccountId').empty();
                $('#floatingAccountId').append('<option value="">Select Account</option>');
                $.each(data, function (index, item) {
                    $('#floatingAccountId').append('<option value="' + item.Value + '">' + item.Text + '</option>');
                });
            },
            error: function (error) {
                console.log("Error: " + error);
            }
        });
    }

    function togglePaymentMethodFields(paymentMethod) {
        if (paymentMethod == 'Cash') {
            $('#floatingInstrumentNo').closest('.form-floating').hide();
            $('#floatingInstrumentDate').closest('.form-floating').hide();
        } else {
            $('#floatingInstrumentNo').closest('.form-floating').show();
            $('#floatingInstrumentDate').closest('.form-floating').show();
        }
    }

    $('#floatingPaymentMethod').change(function () {
        var paymentMethod = $(this).val();
        loadAccounts(paymentMethod);
        togglePaymentMethodFields(paymentMethod);
    });

    // Set default selection to "Bank" and trigger change to load accounts
    $('#floatingPaymentMethod').val('Cash');
    $('#floatingPaymentMethod').trigger('change');
});

</script>