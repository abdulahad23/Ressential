@model IEnumerable<Ressential.Models.Product>

@{
    ViewBag.Title = "Shop";
    Layout = "~/Views/Shared/CustomerLayout.cshtml";
}

<div class="hero-wrap hero-bread" style="background-image: url('/Content/CustomerAssets/images/BG1.jpg');">
    <div class="container">
        <div class="row no-gutters slider-text align-items-center justify-content-center">
            <div class="col-md-9 ftco-animate text-center">
                <p class="breadcrumbs">
                    <span class="mr-2">
                        <a href="@Url.Action("Index", "Customer")" style="color: #fff; text-decoration: none; font-weight: bold;">Home</a>
                    </span>
                    <span>
                        <a href="@Url.Action("Shop", "Customer")" style="color: #fff; text-decoration: none; font-weight: bold;">Products</a>
                    </span>
                </p>
                <h1 style="font-size: 48px; font-weight: bold; color: #fff; text-align: center; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); margin: 20px 0;">Products</h1>
            </div>
        </div>
    </div>
</div>

<section class="ftco-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10 mb-5 text-center">
                <ul class="product-category">
                    <li>
                        <a href="@Url.Action("Shop", "Customer", new { categoryId = (int?)null })"
                           class="@(ViewBag.SelectedCategoryId == null ? "active" : "")">All</a>
                    </li>
                    @foreach (var category in ViewBag.Categories as IEnumerable<Ressential.Models.ProductCategory>)
                    {
                        <li>
                            <a href="@Url.Action("Shop", "Customer", new { categoryId = category.ProductCategoryId })"
                               class="@(ViewBag.SelectedCategoryId == category.ProductCategoryId ? "active" : "")">
                                @category.ProductCategoryName
                            </a>
                        </li>
                    }
                </ul>
            </div>
        </div>

        <div class="container">
            <div class="row">
                @foreach (var product in Model)
                {
                    <div class="col-md-6 col-lg-3 ftco-animate">
                        <div class="product">
                            <a href="#" class="img-prod product-link" data-product-id="@product.ProductId" data-product-name="@product.ProductName" data-product-description="@product.Description" data-product-price="@product.ProductPrice" data-product-image="@Url.Content("~/Uploads/ProductImages/" + product.ProductImage)">
                                <img class="img-fluid" src="@Url.Content("~/Uploads/ProductImages/"+ product.ProductImage)" style="width: 200px; height: 200px; margin: 0 auto; display: block;" alt="Product Image" />
                            </a>
                            <div class="text py-3 pb-4 px-3 text-center">
                                <h3><a href="#" class="product-link" data-product-id="@product.ProductId" data-product-name="@product.ProductName" data-product-description="@product.Description" data-product-price="@product.ProductPrice" data-product-image="@Url.Content("~/Uploads/ProductImages/" + product.ProductImage)">@product.ProductName</a></h3>
                                <div class="d-flex">
                                    <div class="pricing">
                                        <p class="price">
                                            <span>@product.ProductPrice.ToString("C", new System.Globalization.CultureInfo("en-PK"))</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="bottom-area mt-5 text-center">
                                    <form action="@Url.Action("AddToCart", "Customer")" method="post">
                                        <input type="hidden" name="productId" value="@product.ProductId" />
                                        <button type="submit" class="btn btn-primary cart-box" style="border-radius: 10px; padding: 5px 10px;">
                                            <i class="ion-ios-cart"></i>
                                            <span>Add to Cart</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mt-4">
                @if (ViewBag.TotalPages > 1)
                {
                    // Show the first page link
                    <li class="page-item @(1 == ViewBag.Page ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Shop", new { page = 1 })">1</a>
                    </li>

                    // If current page is beyond 4, show "..."
                    if (ViewBag.Page > 4)
                    {
                        <li class="page-item disabled"><a class="page-link">...</a></li>
                    }

                    // Show pages around the current page
                    for (int i = Math.Max(2, ViewBag.Page - 2); i <= Math.Min(ViewBag.TotalPages - 1, ViewBag.Page + 2); i++)
                    {
                        <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Shop", new { page = i })">@i</a>
                        </li>
                    }

                    // If current page is far from the last page, show "..."
                    if (ViewBag.Page < ViewBag.TotalPages - 3)
                    {
                        <li class="page-item disabled"><a class="page-link">...</a></li>
                    }

                    // Show the last page link
                    if (ViewBag.TotalPages > 1)
                    {
                        <li class="page-item @(ViewBag.TotalPages == ViewBag.Page ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Shop", new { page = ViewBag.TotalPages })">@ViewBag.TotalPages</a>
                        </li>
                    }
                }
            </ul>
        </nav>

    </div>

    @if (ViewBag.CartItemCount > 0)
    {
        <a href="@Url.Action("Cart", "Customer")" class="btn btn-primary cart-go-to" id="cartButton">
            Go to Cart (@ViewBag.CartItemCount items)
        </a>
    }
    <div class="container mt-3">
        <button class="btn btn-primary cart-go-to" style="display:none;" id="cartButtonFallback">
            Go to Cart (0 items)
        </button>
    </div>
</section>

<section class="ftco-section ftco-no-pt ftco-no-pb py-5 bg-light">
    <div class="container py-4">
        <div class="row d-flex justify-content-center py-5">
            <div class="col-md-6">
                <h2 style="font-size: 22px;" class="mb-0">Subscribe to our Newsletter</h2>
                <span>Get e-mail updates about our latest shops and special offers</span>
            </div>
            <div class="col-md-6 d-flex align-items-center">
                <form action="#" class="subscribe-form">
                    <div class="form-group d-flex">
                        <input type="text" class="form-control" placeholder="Enter email address">
                        <input type="submit" value="Subscribe" class="submit px-3">
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
   $(document).ready(function () {
    function attachAddToCartHandler() {
        $(".cart-box").off("click").on("click", function (e) {
            e.preventDefault();
            var productId = $(this).closest("form").find("input[name='productId']").val();
            var url = '@Url.Action("AddToCart", "Customer")';

            $.ajax({
                url: url,
                type: "POST",
                data: { productId: productId },
                success: function (response) {
                    if (!response.success) {
                        // Redirect to login if the user is not authenticated
                        window.location.href = '@Url.Action("Login", "Customer")';
                        return;
                    }
                    $(".cart-count").text(response.cartCount);
                    $(".cart-total").text(response.cartTotal.toFixed(2));

                    if (response.cartCount > 0) {
                        $(".cart-go-to").show().text("Go to Cart (" + response.cartCount + " items)");
                    } else {
                        $(".cart-go-to").hide();
                    }
                    // Close the modal if open
                    if ($("#productModal").hasClass("show")) {
                        $("#productModal").removeClass("show");
                        $("body").removeClass("modal-open");
                    }
                },
                error: function () {
                    alert("There was an error adding the product to the cart.");
                }
            });
        });
    }

    attachAddToCartHandler();

    $(".cart-go-to").off("click").on("click", function () {
        window.location.href = '@Url.Action("Cart", "Customer")';
    });

    // Handle product link click to open modal
    $(".product-link").off("click").on("click", function (e) {
        e.preventDefault();
        var productId = $(this).data("product-id");
        var productName = $(this).data("product-name");
        var productDescription = $(this).data("product-description");
        var productPrice = parseFloat($(this).data("product-price"));
        var productImage = $(this).data("product-image");

        var productDetailsHtml = `
            <img class="img-fluid" src="${productImage}" style="width: 300px; height: auto; margin: 0 auto; display: block;" alt="Product Image" />
            <h3>${productName}</h3>
            <p>${productDescription}</p>
            <p class="price"><span>${productPrice.toFixed(2)}</span></p>
            <form action="@Url.Action("AddToCart", "Customer")" method="post">
                <input type="hidden" name="productId" value="${productId}" />
                <button type="submit" class="btn btn-primary cart-box" style="border-radius: 10px; padding: 5px 10px;">
                    <i class="ion-ios-cart"></i>
                    <span>Add to Cart</span>
                </button>
            </form>
        `;
        $("#productDetails").html(productDetailsHtml);
        $("#productModal").addClass("show");
        $("body").addClass("modal-open");

        // Attach event handler to the dynamically added button
        attachAddToCartHandler();
    });

    // Close modal when the close button is clicked
    $("#closeProductModal").click(function () {
        $("#productModal").removeClass("show");
        $("body").removeClass("modal-open");
    });

    // Close modal when clicking outside the modal content
    $(window).click(function (e) {
        if ($(e.target).is("#productModal")) {
            $("#productModal").removeClass("show");
            $("body").removeClass("modal-open");
        }
    });
});

</script>
